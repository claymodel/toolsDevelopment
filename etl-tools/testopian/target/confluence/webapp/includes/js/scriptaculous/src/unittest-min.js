Event.simulateMouse=function(d,b){var c=Object.extend({pointerX:0,pointerY:0,buttons:0},arguments[2]||{});var a=document.createEvent("MouseEvents");a.initMouseEvent(b,true,true,document.defaultView,c.buttons,c.pointerX,c.pointerY,c.pointerX,c.pointerY,false,false,false,false,0,$(d));if(this.mark){Element.remove(this.mark)}this.mark=document.createElement("div");this.mark.appendChild(document.createTextNode(" "));document.body.appendChild(this.mark);this.mark.style.position="absolute";this.mark.style.top=c.pointerY+"px";this.mark.style.left=c.pointerX+"px";this.mark.style.width="5px";this.mark.style.height="5px;";this.mark.style.borderTop="1px solid red;";this.mark.style.borderLeft="1px solid red;";if(this.step){alert("["+new Date().getTime().toString()+"] "+b+"/"+Test.Unit.inspect(c))}$(d).dispatchEvent(a)};Event.simulateKey=function(d,b){var c=Object.extend({ctrlKey:false,altKey:false,shiftKey:false,metaKey:false,keyCode:0,charCode:0},arguments[2]||{});var a=document.createEvent("KeyEvents");a.initKeyEvent(b,true,true,window,c.ctrlKey,c.altKey,c.shiftKey,c.metaKey,c.keyCode,c.charCode);$(d).dispatchEvent(a)};Event.simulateKeys=function(b,c){for(var a=0;a<c.length;a++){Event.simulateKey(b,"keypress",{charCode:c.charCodeAt(a)})}};var Test={};Test.Unit={};Test.Unit.inspect=function(b){var a=[];if(typeof b=="string"||typeof b=="number"){return b}else{for(property in b){if(typeof b[property]!="function"){a.push(property+" => "+(typeof b[property]=="string"?'"'+b[property]+'"':b[property]))}}}return("'"+b+"' #"+typeof b+": {"+a.join(", ")+"}")};Test.Unit.Logger=Class.create();Test.Unit.Logger.prototype={initialize:function(a){this.log=$(a);if(this.log){this._createLogTable()}},start:function(a){if(!this.log){return}this.testName=a;this.lastLogLine=document.createElement("tr");this.statusCell=document.createElement("td");this.nameCell=document.createElement("td");this.nameCell.appendChild(document.createTextNode(a));this.messageCell=document.createElement("td");this.lastLogLine.appendChild(this.statusCell);this.lastLogLine.appendChild(this.nameCell);this.lastLogLine.appendChild(this.messageCell);this.loglines.appendChild(this.lastLogLine)},finish:function(a,b){if(!this.log){return}this.lastLogLine.className=a;this.statusCell.innerHTML=a;this.messageCell.innerHTML=this._toHTML(b)},message:function(a){if(!this.log){return}this.messageCell.innerHTML=this._toHTML(a)},summary:function(a){if(!this.log){return}this.logsummary.innerHTML=this._toHTML(a)},_createLogTable:function(){this.log.innerHTML='<div id="logsummary"></div><table id="logtable"><thead><tr><th>Status</th><th>Test</th><th>Message</th></tr></thead><tbody id="loglines"></tbody></table>';this.logsummary=$("logsummary");this.loglines=$("loglines")},_toHTML:function(a){return a.escapeHTML().replace(/\n/g,"<br/>")}};Test.Unit.Runner=Class.create();Test.Unit.Runner.prototype={initialize:function(a){this.options=Object.extend({testLog:"testlog"},arguments[1]||{});this.options.resultsURL=this.parseResultsURLQueryParameter();if(this.options.testLog){this.options.testLog=$(this.options.testLog)||null}if(this.options.tests){this.tests=[];for(var c=0;c<this.options.tests.length;c++){if(/^test/.test(this.options.tests[c])){this.tests.push(new Test.Unit.Testcase(this.options.tests[c],a[this.options.tests[c]],a.setup,a.teardown))}}}else{if(this.options.test){this.tests=[new Test.Unit.Testcase(this.options.test,a[this.options.test],a.setup,a.teardown)]}else{this.tests=[];for(var b in a){if(/^test/.test(b)){this.tests.push(new Test.Unit.Testcase(b,a[b],a.setup,a.teardown))}}}}this.currentTest=0;this.logger=new Test.Unit.Logger(this.options.testLog);setTimeout(this.runTests.bind(this),1000)},parseResultsURLQueryParameter:function(){return window.location.search.parseQuery()["resultsURL"]},getResult:function(){var b=false;for(var a=0;a<this.tests.length;a++){if(this.tests[a].errors>0){return"ERROR"}if(this.tests[a].failures>0){b=true}}if(b){return"FAILURE"}else{return"SUCCESS"}},postResults:function(){if(this.options.resultsURL){new Ajax.Request(this.options.resultsURL,{method:"get",parameters:"result="+this.getResult(),asynchronous:false})}},runTests:function(){var a=this.tests[this.currentTest];if(!a){this.postResults();this.logger.summary(this.summary());return}if(!a.isWaiting){this.logger.start(a.name)}a.run();if(a.isWaiting){this.logger.message("Waiting for "+a.timeToWait+"ms");setTimeout(this.runTests.bind(this),a.timeToWait||1000)}else{this.logger.finish(a.status(),a.summary());this.currentTest++;this.runTests()}},summary:function(){var d=0;var b=0;var e=0;var c=[];for(var a=0;a<this.tests.length;a++){d+=this.tests[a].assertions;b+=this.tests[a].failures;e+=this.tests[a].errors}return(this.tests.length+" tests, "+d+" assertions, "+b+" failures, "+e+" errors")}};Test.Unit.Assertions=Class.create();Test.Unit.Assertions.prototype={initialize:function(){this.assertions=0;this.failures=0;this.errors=0;this.messages=[]},summary:function(){return(this.assertions+" assertions, "+this.failures+" failures, "+this.errors+" errors\n"+this.messages.join("\n"))},pass:function(){this.assertions++},fail:function(a){this.failures++;this.messages.push("Failure: "+a)},error:function(a){this.errors++;this.messages.push(a.name+": "+a.message+"("+Test.Unit.inspect(a)+")")},status:function(){if(this.failures>0){return"failed"}if(this.errors>0){return"error"}return"passed"},assert:function(c){var a=arguments[1]||'assert: got "'+Test.Unit.inspect(c)+'"';try{c?this.pass():this.fail(a)}catch(b){this.error(b)}},assertEqual:function(b,d){var a=arguments[2]||"assertEqual";try{(b==d)?this.pass():this.fail(a+': expected "'+Test.Unit.inspect(b)+'", actual "'+Test.Unit.inspect(d)+'"')}catch(c){this.error(c)}},assertNotEqual:function(b,d){var a=arguments[2]||"assertNotEqual";try{(b!=d)?this.pass():this.fail(a+': got "'+Test.Unit.inspect(d)+'"')}catch(c){this.error(c)}},assertNull:function(c){var a=arguments[1]||"assertNull";try{(c==null)?this.pass():this.fail(a+': got "'+Test.Unit.inspect(c)+'"')}catch(b){this.error(b)}},assertHidden:function(a){var b=arguments[1]||"assertHidden";this.assertEqual("none",a.style.display,b)},assertNotNull:function(a){var b=arguments[1]||"assertNotNull";this.assert(a!=null,b)},assertInstanceOf:function(b,d){var a=arguments[2]||"assertInstanceOf";try{(d instanceof b)?this.pass():this.fail(a+": object was not an instance of the expected type")}catch(c){this.error(c)}},assertNotInstanceOf:function(b,d){var a=arguments[2]||"assertNotInstanceOf";try{!(d instanceof b)?this.pass():this.fail(a+": object was an instance of the not expected type")}catch(c){this.error(c)}},_isVisible:function(a){a=$(a);if(!a.parentNode){return true}this.assertNotNull(a);if(a.style&&Element.getStyle(a,"display")=="none"){return false}return this._isVisible(a.parentNode)},assertNotVisible:function(a){this.assert(!this._isVisible(a),Test.Unit.inspect(a)+" was not hidden and didn't have a hidden parent either. "+(""||arguments[1]))},assertVisible:function(a){this.assert(this._isVisible(a),Test.Unit.inspect(a)+" was not visible. "+(""||arguments[1]))}};Test.Unit.Testcase=Class.create();Object.extend(Object.extend(Test.Unit.Testcase.prototype,Test.Unit.Assertions.prototype),{initialize:function(b,d,a,c){Test.Unit.Assertions.prototype.initialize.bind(this)();this.name=b;this.test=d||function(){};this.setup=a||function(){};this.teardown=c||function(){};this.isWaiting=false;this.timeToWait=1000},wait:function(b,a){this.isWaiting=true;this.test=a;this.timeToWait=b},run:function(){try{try{if(!this.isWaiting){this.setup.bind(this)()}this.isWaiting=false;this.test.bind(this)()}finally{if(!this.isWaiting){this.teardown.bind(this)()}}}catch(a){this.error(a)}}});