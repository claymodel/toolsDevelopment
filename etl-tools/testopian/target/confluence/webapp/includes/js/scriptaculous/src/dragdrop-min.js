var Droppables={drops:[],remove:function(a){this.drops=this.drops.reject(function(b){return b.element==a})},add:function(b){b=$(b);var a=Object.extend({greedy:true,hoverclass:null},arguments[1]||{});if(a.containment){a._containers=[];var c=a.containment;if((typeof c=="object")&&(c.constructor==Array)){c.each(function(d){a._containers.push($(d))})}else{a._containers.push($(c))}}Element.makePositioned(b);a.element=b;this.drops.push(a)},isContained:function(c,b){var a=c.parentNode;return b._containers.detect(function(d){return a==d})},isAffected:function(c,b,d,a){return((a.element!=d)&&((!a._containers)||this.isContained(d,a))&&((!a.accept)||(Element.Class.has_any(d,a.accept)))&&Position.within(a.element,c,b))},deactivate:function(a){if(a.hoverclass){Element.Class.remove(a.element,a.hoverclass)}this.last_active=null},activate:function(a){if(this.last_active){this.deactivate(this.last_active)}if(a.hoverclass){Element.Class.add(a.element,a.hoverclass)}this.last_active=a},show:function(f,e){if(!this.drops.length){return}var c=Event.pointerX(f);var b=Event.pointerY(f);Position.prepare();var d=this.drops.length-1;do{var a=this.drops[d];if(this.isAffected(c,b,e,a)){if(a.onHover){a.onHover(e,a.element,Position.overlap(a.overlap,a.element))}if(a.greedy){this.activate(a);return}}}while(d--);if(this.last_active){this.deactivate(this.last_active)}},fire:function(b,a){if(!this.last_active){return}Position.prepare();if(this.isAffected(Event.pointerX(b),Event.pointerY(b),a,this.last_active)){if(this.last_active.onDrop){this.last_active.onDrop(a,this.last_active.element,b)}}},reset:function(){if(this.last_active){this.deactivate(this.last_active)}}};var Draggables={observers:[],addObserver:function(a){this.observers.push(a)},removeObserver:function(a){this.observers=this.observers.reject(function(b){return b.element==a})},notify:function(b,a){this.observers.invoke(b,a)}};var Draggable=Class.create();Draggable.prototype={initialize:function(b){var a=Object.extend({handle:false,starteffect:function(c){new Effect.Opacity(c,{duration:0.2,from:1,to:0.7})},reverteffect:function(e,d,c){var f=Math.sqrt(Math.abs(d^2)+Math.abs(c^2))*0.02;new Effect.MoveBy(e,-d,-c,{duration:f})},endeffect:function(c){new Effect.Opacity(c,{duration:0.2,from:0.7,to:1})},zindex:1000,revert:false},arguments[1]||{});this.element=$(b);if(a.handle&&(typeof a.handle=="string")){this.handle=Element.Class.childrenWith(this.element,a.handle)[0]}if(!this.handle){this.handle=$(a.handle)}if(!this.handle){this.handle=this.element}Element.makePositioned(this.element);this.offsetX=0;this.offsetY=0;this.originalLeft=this.currentLeft();this.originalTop=this.currentTop();this.originalX=this.element.offsetLeft;this.originalY=this.element.offsetTop;this.options=a;this.active=false;this.dragging=false;this.eventMouseDown=this.startDrag.bindAsEventListener(this);this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.update.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);this.registerEvents()},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);this.unregisterEvents()},registerEvents:function(){Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress);Event.observe(this.handle,"mousedown",this.eventMouseDown)},unregisterEvents:function(){},currentLeft:function(){return parseInt(this.element.style.left||"0")},currentTop:function(){return parseInt(this.element.style.top||"0")},startDrag:function(b){if(Event.isLeftClick(b)){var d=Event.element(b);if(d.tagName&&(d.tagName=="INPUT"||d.tagName=="SELECT"||d.tagName=="BUTTON"||d.tagName=="TEXTAREA")){return}this.active=true;var c=[Event.pointerX(b),Event.pointerY(b)];var a=Position.cumulativeOffset(this.element);this.offsetX=(c[0]-a[0]);this.offsetY=(c[1]-a[1]);Event.stop(b)}},finishDrag:function(b,c){this.active=false;this.dragging=false;if(this.options.ghosting){Position.relativize(this.element);Element.remove(this._clone);this._clone=null}if(c){Droppables.fire(b,this.element)}Draggables.notify("onEnd",this);var a=this.options.revert;if(a&&typeof a=="function"){a=a(this.element)}if(a&&this.options.reverteffect){this.options.reverteffect(this.element,this.currentTop()-this.originalTop,this.currentLeft()-this.originalLeft)}else{this.originalLeft=this.currentLeft();this.originalTop=this.currentTop()}if(this.originalZ&&this.options.zindex){this.element.style.zIndex=this.originalZ}if(this.options.endeffect){this.options.endeffect(this.element)}Droppables.reset()},keyPress:function(a){if(this.active){if(a.keyCode==Event.KEY_ESC){this.finishDrag(a,false);Event.stop(a)}}},endDrag:function(a){if(this.active&&this.dragging){this.finishDrag(a,true);Event.stop(a)}this.active=false;this.dragging=false},draw:function(c){var d=[Event.pointerX(c),Event.pointerY(c)];var b=Position.cumulativeOffset(this.element);b[0]-=this.currentLeft();b[1]-=this.currentTop();var a=this.element.style;if((!this.options.constraint)||(this.options.constraint=="horizontal")){a.left=(d[0]-b[0]-this.offsetX)+"px"}if((!this.options.constraint)||(this.options.constraint=="vertical")){a.top=(d[1]-b[1]-this.offsetY)+"px"}if(a.visibility=="hidden"){a.visibility=""}},update:function(b){if(this.active){if(!this.dragging){var a=this.element.style;this.dragging=true;if(Element.getStyle(this.element,"position")==""){a.position="relative"}if(this.options.zindex){this.options.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0);a.zIndex=this.options.zindex}if(this.options.ghosting){this._clone=this.element.cloneNode(true);Position.absolutize(this.element);this.element.parentNode.insertBefore(this._clone,this.element)}Draggables.notify("onStart",this);if(this.options.starteffect){this.options.starteffect(this.element)}}Droppables.show(b,this.element);this.draw(b);if(this.options.change){this.options.change(this)}if(navigator.appVersion.indexOf("AppleWebKit")>0){window.scrollBy(0,0)}Event.stop(b)}}};var SortableObserver=Class.create();SortableObserver.prototype={initialize:function(b,a){this.element=$(b);this.observer=a;this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark();if(this.lastValue!=Sortable.serialize(this.element)){this.observer(this.element)}}};var Sortable={sortables:new Array(),options:function(a){a=$(a);return this.sortables.detect(function(b){return b.element==a})},destroy:function(a){a=$(a);this.sortables.findAll(function(b){return b.element==a}).each(function(b){Draggables.removeObserver(b.element);b.droppables.each(function(c){Droppables.remove(c)});b.draggables.invoke("destroy")});this.sortables=this.sortables.reject(function(b){return b.element==a})},create:function(c){c=$(c);var b=Object.extend({element:c,tag:"li",dropOnEmpty:false,tree:false,overlap:"vertical",constraint:"vertical",containment:c,handle:false,only:false,hoverclass:null,ghosting:false,format:null,onChange:function(){},onUpdate:function(){}},arguments[1]||{});this.destroy(c);var a={revert:true,ghosting:b.ghosting,constraint:b.constraint,handle:b.handle};if(b.starteffect){a.starteffect=b.starteffect}if(b.reverteffect){a.reverteffect=b.reverteffect}else{if(b.ghosting){a.reverteffect=function(e){e.style.top=0;e.style.left=0}}}if(b.endeffect){a.endeffect=b.endeffect}if(b.zindex){a.zindex=b.zindex}var d={overlap:b.overlap,containment:b.containment,hoverclass:b.hoverclass,onHover:Sortable.onHover,greedy:!b.dropOnEmpty};Element.cleanWhitespace(c);b.draggables=[];b.droppables=[];if(b.dropOnEmpty){Droppables.add(c,{containment:b.containment,onHover:Sortable.onEmptyHover,greedy:false});b.droppables.push(c)}(this.findElements(c,b)||[]).each(function(g){var f=b.handle?Element.Class.childrenWith(g,b.handle)[0]:g;b.draggables.push(new Draggable(g,Object.extend(a,{handle:f})));Droppables.add(g,d);b.droppables.push(g)});this.sortables.push(b);Draggables.addObserver(new SortableObserver(c,b.onUpdate))},findElements:function(b,a){if(!b.hasChildNodes()){return null}var c=[];$A(b.childNodes).each(function(f){if(f.tagName&&f.tagName==a.tag.toUpperCase()&&(!a.only||(Element.Class.has(f,a.only)))){c.push(f)}if(a.tree){var d=this.findElements(f,a);if(d){c.push(d)}}});return(c.length>0?c.flatten():null)},onHover:function(e,d,a){if(a>0.5){Sortable.mark(d,"before");if(d.previousSibling!=e){var b=e.parentNode;e.style.visibility="hidden";d.parentNode.insertBefore(e,d);if(d.parentNode!=b){Sortable.options(b).onChange(e)}Sortable.options(d.parentNode).onChange(e)}}else{Sortable.mark(d,"after");var c=d.nextSibling||null;if(c!=e){var b=e.parentNode;e.style.visibility="hidden";d.parentNode.insertBefore(e,c);if(d.parentNode!=b){Sortable.options(b).onChange(e)}Sortable.options(d.parentNode).onChange(e)}}},onEmptyHover:function(b,a){if(b.parentNode!=a){a.appendChild(b)}},unmark:function(){if(Sortable._marker){Element.hide(Sortable._marker)}},mark:function(b,a){var d=Sortable.options(b.parentNode);if(d&&!d.ghosting){return}if(!Sortable._marker){Sortable._marker=$("dropmarker")||document.createElement("DIV");Element.hide(Sortable._marker);Element.Class.add(Sortable._marker,"dropmarker");Sortable._marker.style.position="absolute";document.getElementsByTagName("body").item(0).appendChild(Sortable._marker)}var c=Position.cumulativeOffset(b);Sortable._marker.style.top=c[1]+"px";if(a=="after"){Sortable._marker.style.top=(c[1]+b.clientHeight)+"px"}Sortable._marker.style.left=c[0]+"px";Element.show(Sortable._marker)},serialize:function(c){c=$(c);var b=this.options(c);var a=Object.extend({tag:b.tag,only:b.only,name:c.id,format:b.format||/^[^_]*_(.*)$/},arguments[1]||{});return $(this.findElements(c,a)||[]).collect(function(d){return(encodeURIComponent(a.name)+"[]="+encodeURIComponent(d.id.match(a.format)?d.id.match(a.format)[1]:""))}).join("&")}};