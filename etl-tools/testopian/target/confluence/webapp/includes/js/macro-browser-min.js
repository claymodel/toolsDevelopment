AJS.MacroBrowser=(function(b){var a={};return{hasInit:false,metadataList:[],aliasMap:{},fields:{},Macros:a,getMacroJsOverride:function(c){return a[c]},setMacroJsOverride:function(d,c){return a[d]=c},parseMacro:function(g){var e=g.match(/(\{(.+?)(?::(.*?(?=[^\\]\}).)?)?\})(?:((?:\n|.)*?)\{\2\})?/);var f={markup:e[0],startTag:e[1],name:e[2],paramStr:e[3],bodyMarkup:e[4],params:{}};if(f.markup){var c=g.split(f.markup);f.beforeTag=c[0];f.afterTag=c[1]}if(f.paramStr){var d=f.paramStr.split("|");b(d).each(function(j,k){var h=k.indexOf("=");if(h<0&&!f.params[""]){f.params[""]=k}else{f.params[k.substring(0,h)]=k.substring(h+1)}})}return f},getSelectedMacro:function(d,e){var c=/^(?:.|\n)*[^\\](?={(?:\\}|[^}])+$)/m.exec(" "+d+" ");if(!c){return null}var g=c[0].substring(1).length;var f=AJS.MacroBrowser.parseMacro(e.substring(g));f.startIndex=g;f.params={};if(f.paramStr){f.paramStr.replace(/(?=(?:^|\|)(.*?)(?:=(.*?))?(?:\||$))/g,function(h,i,j){if((!j||j=="")&&!f.params[""]){f.params[""]=i}else{f.params[i]=j}})}return f},makeParameterDiv:function(k,f,c){var n=this,m;var i=f.type.name;if(c){var h=c.fields&&c.fields[i];if(h&&typeof h!="function"){h=h[f.name]}if(typeof h=="function"){m=h.call(c,f)}}if(!m){if(!(i in n.ParameterFields&&typeof n.ParameterFields[i]=="function")){i="string"}m=n.ParameterFields[i](f)}n.fields[f.name]=m;var j=m.paramDiv;var l=m.input;var d="macro-param-"+f.name;j.attr("id","macro-param-div-"+f.name);l.addClass("macro-param-input").attr("id",d);if(f.hidden){j.hide()}var g=k.pluginKey;if(f.displayName==n.makeDefaultKey(g,k.macroName,"param",f.name,"label")){f.displayName=f.name}if(f.description==n.makeDefaultKey(g,k.macroName,"param",f.name,"desc")){f.description=""}var e=f.displayName;if(f.required){e+=" *";j.addClass("required")}b("label",j).attr("for",d).text(e);if(f.description){j.append(AJS.clone("#macro-param-desc-template").html(f.description))}return j},makeBodyDiv:function(c,d){var e=AJS.MacroBrowser;var f=AJS.clone("#macro-body-template");b("textarea",f).val((d&&d.bodyMarkup)||e.settings.selectedMarkup||"");if(c.label){b("label",f).text(c.label)}if(c.description){f.append(AJS.clone("#macro-param-desc-template").html(c.description))}if(c.hidden){f.hide()}return f},processRequiredParameters:function(){var c=b("#macro-insert-container .macro-param-div.required .macro-param-input").filter(function(){var g=b(this).val();return(g==null||g=="")});var f=(c.length==0);var e=f?"":"disabled";var d=e?"addClass":"removeClass";AJS.$("#macro-browser-dialog button.ok").attr("disabled",e);AJS.$("#macro-browser-dialog .macro-preview-header .refresh-link").attr("disabled",e)[d]("disabled");return f},paramChanged:function(){AJS.MacroBrowser.processRequiredParameters()},loadMacroInBrowser:function(m,p){if(!m||!m.formDetails){alert(AJS.I18n.getText("macro.browser.unknown.macro.message"));return}var o=AJS.MacroBrowser,x=m.formDetails,d=x.macroName,c=a[d],s=o.settings.selectedMacro,u=p=="edit"?o.editTitle:o.insertTitle;b("#save-warning-span").addClass("hidden");AJS.MacroBrowser.dialog.gotoPage(1).addHeader(u.replace(/\{0\}/,m.title));var z=AJS.$("#macro-browser-dialog .dialog-button-panel .ok");if(p=="edit"){z.text(AJS.I18n.getText("save.name"))}else{z.text(AJS.I18n.getText("insert.name"))}AJS.$("#macro-insert-container .macro-name").val(d);var k=m.extendedDescription?m.extendedDescription:m.description;var A=AJS.clone("#macro-summary-template .macro-desc").prepend(k),n=b("#macro-insert-container .macro-input-fields").html(A);if(x.documentationUrl){var q=AJS.clone("#macro-doco-link-template");AJS.$("a",q).attr("href",x.documentationUrl);A.append(q)}else{if(!A.text()){A.remove()}}if(x.body){var h=m.pluginKey;if(x.body.label==o.makeDefaultKey(h,d,"body","label")){x.body.label=""}if(x.body.description==o.makeDefaultKey(h,d,"body","desc")){x.body.description=""}var l=o.makeBodyDiv(x.body,s)}if(x.freeform){var e=(s&&s.paramStr)||"",j=AJS.clone("#macro-freeform-template");b(".macro-name-display",j).text(d+": ");b(".macro-text",j).val(e);if(l){l=l.append("{"+d+"}");AJS.$(".macro-freeform-input",j).after(l)}if(x.notationHelp){var y=AJS.$(x.notationHelp).children();if(y[0]){if(!s){var v=AJS.$(y[0]).html().replace(/<br>/gi,"\n").replace(/<[^>]+>/gi,"");var i=v.indexOf("{"+d);if(i>-1){var w=o.parseMacro(v.substring(i));if(w.paramStr){b(".macro-freeform-input input",j).val(w.paramStr)}if(w.bodyMarkup){b(".macro-body-div textarea",j).val(w.bodyMarkup.replace(/^\n|\n$/g,"").replace(/^\s+|\s+$/gm,""))}}}b(".macro-example",j).append(y[0].innerHTML).removeClass("hidden")}if(y[1]){b(".macro-help",j).append(y[1].innerHTML).removeClass("hidden")}}n.append(j)}else{if(l){n.append(l)}b(x.parameters).each(function(){n.append(o.makeParameterDiv(m,this,c))});var r=s?b.extend({},s.params):{};if(c&&typeof c.beforeParamsSet=="function"){r=c.beforeParamsSet(r,!s)}var g={};if(c&&typeof c.populateBodyParams=="function"){g=c.populateBodyParams(l)}b(x.parameters).each(function(){var B=this,t=r[B.name];if(t!=null){delete r[B.name]}else{b(B.aliases).each(function(){if(r[this]){t=r[this];delete r[this]}})}if(t==null){if(g[B.name]){t=g[B.name]}else{t=B.defaultValue}}if(t!=null){o.fields[B.name].setValue(t)}});o.unknownParams=r}b("a",n).click(function(){window.open(this.href,"_blank").focus();return false});if(!b("#macro-browser-dialog:visible").length){o.showBrowserDialog()}var f=b(":input:visible:first",n);if(f.length){f.focus();if(!s&&f.val()!=""&&f[0].select){f[0].select()}}o.previewMacro(m)},makeParamStringFromMap:function(c){var d=[];if(c[""]){d.push(c[""]);delete c[""]}for(var e in c){d.push(e+"="+c[e])}return d.join("|")},getMacroMarkupFromForm:function(j){var d=b("#macro-insert-container .macro-name").val(),l="{"+d,m=b("#macro-insert-container .macro-text"),e,n=AJS.MacroBrowser;if(m.length){e=m.val()}else{var i={},f={},h=j.formDetails.parameters;b(h).each(function(){var o=AJS.$("#macro-param-"+this.name);var p=o.val();if(o.attr("type")=="checkbox"){p=""+o.attr("checked")}if(this.forBody){if(p){f[this.name]=p}}else{if(p&&(this.hidden||(!this.defaultValue||this.defaultValue!=p))){i[this.name]=p}}});if(n.unknownParams){b.each(n.unknownParams,function(o,p){i[o]=p})}var c=a[d];if(c&&typeof c.beforeParamsRetrieved=="function"){i=c.beforeParamsRetrieved(i)}e=n.makeParamStringFromMap(i)}if(e){l+=":"+e}l+="}";var g={name:d,startTag:l,markup:l,bodyMarkup:"",hasBody:AJS.$("#macro-insert-container .macro-body-div").length>0};if(g.hasBody){var k=AJS.$("#macro-insert-container .macro-body-div textarea").val();c=a[d];if(c&&c.applySpecialBodyHandling){k=c.applySpecialBodyHandling(j,k,f)}g.bodyMarkup=k;g.markup+=g.bodyMarkup;g.markup+="{"+d+"}"}return g},previewMacro:function(e){var d=AJS.MacroBrowser;b("#macro-insert-container .macro-preview").html("");if(!d.processRequiredParameters()){AJS.log("previewMacro: missing required params");return}AJS.log("previewMacro: required params ok");d.showPreviewWaitImage(true);var g=d.getMacroMarkupFromForm(e).markup,c=a[e.macroName];if(c&&c.prepareMacroForPreview){g=c.prepareMacroForPreview(g)}var f={contentId:AJS.Editor.getContentId(),contentType:AJS.params.contentType,spaceKey:AJS.params.spaceKey,wikiMarkup:g};b.post(AJS.params.contextPath+"/pages/rendercontent.action",f,function(h){AJS.MacroBrowser.showPreviewWaitImage(false);var m=AJS.params.staticResourceUrlPrefix+"/blank.html";var l=AJS.$("#macro-insert-container .macro-preview");l.html('<iframe src="'+m+'" frameborder="0" name="macro-browser-preview-frame" id="macro-preview-iframe"></iframe>');AJS.log("previewMacro: Created iframe");var i=AJS.$("#macro-insert-container .macro-preview iframe")[0];var k=i.contentDocument||i.contentWindow.document;k.write(h);k.close();var j=b("div.error span.error",k);if(j.length){AJS.log("Error rendering markup : "+g)}AJS.log("previewMacro: rendered")})},showPreviewWaitImage:function(c){if(c){b("#macro-browser-preview-link").attr("disabled",true).addClass("disabled");var d=AJS("div").addClass("macro-loading");b("#macro-browser-preview").append(d);AJS.MacroBrowser.previewSpinner=Raphael.spinner(d[0],60,"#666");AJS.MacroBrowser.previewSpinner.throbber=d}else{if(AJS.MacroBrowser.previewSpinner){b("#macro-browser-preview").removeClass("macro-loading");AJS.MacroBrowser.previewSpinner();AJS.MacroBrowser.previewSpinner.throbber.remove();delete AJS.MacroBrowser.previewSpinner;b("#macro-browser-preview-link").attr("disabled",false).removeClass("disabled")}}},previewOnload:function(c){var e=AJS.MacroBrowser.dialog.activeMetadata.macroName;var d=a[e];if(d&&d.postPreview){d.postPreview(AJS.$("#macro-preview-iframe")[0],AJS.MacroBrowser.dialog.activeMetadata)}AJS.Editor.disableFrame(c);b(c).click(function(h){if(h.target.tagName.toLowerCase()==="a"){var f=h.target;var g=b(f).attr("href");if(g&&g.indexOf("#")!=0&&g.indexOf(window.location)==-1){window.open(g,"_blank").focus()}return false}})},getMacroMetadata:function(f){for(var e=0,c=this.metadataList.length;e<c;e++){var d=this.metadataList[e];if(d.macroName==f){return d}}return null},open:function(e){if(!e){e={};AJS.log("No settings to open the macro browser.")}var d=AJS.MacroBrowser;var f=e.selectedMacro;if(f&&f.name){var c=d.getMacroJsOverride(f.name);if(c&&typeof c.opener=="function"){c.opener(f);return}}if(!d.hasInit){AJS.log("init macro browser");d.showBrowserSpinner(true);if(d.initData){d.initBrowser()}else{d.initMacroBrowserAfterRequest=e;return}}d.openMacroBrowser(e)},openMacroBrowser:function(d){var k=AJS.MacroBrowser;k.settings=d;if(d.presetMacroName){d.presetMacroMetadata=k.getMacroMetadata(d.presetMacroName)}var f=d.presetMacroMetadata;if(!f){var l=d.selectedMacro;if(l){var e=l.name.toLowerCase();e=k.aliasMap[e]||e;var c=a[e];if(c){if(typeof c.updateSelectedMacro=="function"){c.updateSelectedMacro(l)}var j=c.getMacroDetailsFromSelectedMacro;if(j){f=j(k.metadataList,l)}}if(!f){f=AJS.MacroBrowser.getMacroMetadata(e)}}}if(f){AJS.log("Open macro browser to edit macro: "+f.macroName);b("#macro-browser-dialog button.back").hide();k.replicateSelectMacro(f,d.mode||"edit")}else{b("#macro-browser-dialog button.back").show();k.showBrowserDialog();if(d.selectedCategory){var g=b("#select-macro-page .dialog-page-menu button").index(b("#category-button-"+d.selectedCategory));if(g<0){g=0}k.dialog.gotoPanel(0,g)}else{k.dialog.gotoPanel(0,0)}var i=b.trim(d.searchText);var h=b("#macro-browser-search");h.val(i).keyup();i&&h.removeClass("blank-search");h.focus()}},showBrowserDialog:function(){AJS.MacroBrowser.dialog.show();AJS.MacroBrowser.showBrowserSpinner(false)},complete:function(g){if(!b("#macro-browser-dialog .dialog-button-panel .ok").is(":visible:not(:disabled)")){return}var f=AJS.MacroBrowser;var e=f.dialog.activeMetadata;var c=a[e.macroName];if(c&&c.manipulateMarkup){c.manipulateMarkup(e)}var d=f.getMacroMarkupFromForm(e);f.close();if(f.settings.onComplete){f.settings.onComplete(d)}},cancel:function(){var c=AJS.MacroBrowser;c.close();if(typeof c.settings.onCancel=="function"){c.settings.onCancel()}},close:function(){var c=this;c.unknownParams={};c.fields={};c.dialog.hide()},replicateSelectMacro:function(c,d){AJS.MacroBrowser.dialog.activeMetadata=c;AJS.MacroBrowser.loadMacroInBrowser(c,d)},makeDefaultKey:function(){return b.makeArray(arguments).join(".")},showBrowserSpinner:function(c){var d=AJS.Editor.inRichTextMode()?".defaultSkin span.mce_conf_macro_browser":"#editor-insert-macro";if(c){b(d).addClass("wait")}else{b(d).removeClass("wait")}},initBrowser:function(){var q=AJS.MacroBrowser,z=q.initData;if(!z.categories||!AJS.MacroBrowser.metadataList.length){alert(AJS.I18n.getText("macro.browser.load.error.message"));AJS.MacroBrowser.showBrowserSpinner(false);return false}var s=new Date();var x=q.dialog=AJS.ConfluenceDialog({width:865,height:530,id:"macro-browser-dialog",onSubmit:q.complete,onCancel:q.cancel});x.getPage(0).element.attr("id","select-macro-page");x.addHeader(z.title);q.editTitle=z.editTitle;q.insertTitle=z.insertTitle;var r;z.categories=b.map(z.categories,function(i){if(i.name=="hidden-macros"){r=i;return null}return i});z.categories.sort(function(j,i){return(j.displayName.toLowerCase()>i.displayName.toLowerCase()?1:-1)});if(r&&AJS.params.showHiddenUserMacros){z.categories.push(r)}var d=function(i){return b("#macro-summaries-template").clone().attr("id","category-"+i)};var l=function(A){var B=AJS.clone("#macro-summary-template").click(function(i){if(q.settings.nestingMacros&&(b.inArray(A.macroName,q.settings.nestingMacros)>-1)){alert(AJS.I18n.getText("macro.browser.nesting.same.macro.not.allowed.message"));return AJS.stopEvent(i)}x.activeMetadata=A;AJS.MacroBrowser.loadMacroInBrowser(A,"insert")});if(A.icon){var C=(A.icon.relative?AJS.params.staticResourceUrlPrefix:"")+A.icon.location;if(!A.icon.relative&&AJS.$.browser.msie&&!window.location.href.indexOf("https")&&C.indexOf("https")){B.prepend("<span class='macro-icon-holder icon-"+A.macroName+"'></span>")}else{B.prepend("<img src='"+C+"' alt='icon' width='"+A.icon.width+"' height='"+A.icon.height+"' title='"+A.title+"'/>")}}else{B.prepend("<span class='macro-icon-holder icon-"+A.macroName+"'></span>")}b(".macro-title",B).text(A.title);b(".macro-desc",B).prepend(A.description);if(A.macroName=="gadget"){var j;for(var t=0;t<A.formDetails.parameters.length;t++){if(A.formDetails.parameters[t].name=="url"){j=encodeURI(A.formDetails.parameters[t].defaultValue);break}}if(j){if(!j.match("^https?://.*")){j=AJS.params.contextPath+"/"+j}b(".macro-title",B).after(AJS.template.load("macro-browser-gadget-url").fill({url:j}))}}return B};var e={all:d("all")},w,m,v,y;for(w=0,m=q.metadataList.length;w<m;w++){var n=q.metadataList[w];if(n.hidden){if(!AJS.params.showHiddenUserMacros){continue}if(n.pluginKey!="_-user-macro-_"){continue}n.categories.push("hidden-macros")}var p=l(n).attr("id",n.id);e.all.append(p);for(v=0,y=n.categories.length;v<y;v++){var o=n.categories[v];e[o]=e[o]||d(o);e[o].append(l(n).attr("id",o+"-"+n.id))}}x.addPanel(AJS.I18n.getText("macro.browser.category.all"),e.all,"all","category-button-all");for(w=0,m=z.categories.length;w<m;w++){var u=z.categories[w];x.addPanel(u.displayName,e[u.name]||d(u.name),u.name,"category-button-"+u.name).getPanel(w).setPadding(0)}x.addCancel(AJS.I18n.getText("cancel.name"),AJS.MacroBrowser.cancel);x.popup.element.find(".dialog-title").append(AJS.template.load("macro-browser-help-link"));x.addHelpText(AJS.I18n.getText("macro.browser.shortcut.tip"));var g=AJS.$("#macro-insert-template").clone().attr("id","macro-insert-container");b(".macro-preview-container .macro-preview",g).attr("id","macro-browser-preview");b(".macro-preview-container .macro-preview-header .refresh-link",g).attr("id","macro-browser-preview-link").click(function(i){AJS.MacroBrowser.previewMacro(x.activeMetadata);return AJS.stopEvent(i)});x.addPage().addPanel("X",g,"macro-input-panel").addLink(AJS.I18n.getText("macro.browser.back.button"),function(i){i.prevPage();b("#macro-browser-search").focus()},"dialog-back-link").addButton("insert.name",function(){AJS.MacroBrowser.complete()},"ok").addCancel(AJS.I18n.getText("cancel.name"),function(){AJS.MacroBrowser.cancel()}).getPanel(0).setPadding(0);b("#macro-browser-dialog .dialog-button-panel .ok").before("<span id='save-warning-span' class='hidden'/>");var f=function(t){var j=null;if(t!=""){if(x.getCurrentPanel()!=x.getPanel(0)){x.gotoPanel(0)}var i=q.searchSummaries(t);j={};b.each(i,function(){j[this.id]=this})}b("#macro-browser-dialog .dialog-panel-body #category-all .macro-list-item").each(function(){(!j||this.id in j)?b(this).show():b(this).hide()})};var h=b("<form id='macro-browser-search-form'><input type='text'/></form>");var c=b("input",h).attr("id","macro-browser-search").keyup(function(i){f(b.trim(c.val()))}).focus(function(j){var i=b(j.target);if(i.hasClass("blank-search")){i.removeClass("blank-search").val("")}j.target.select()}).blur(function(j){var i=b(j.target);if(b.trim(i.val())==""){i.addClass("blank-search").val(AJS.I18n.getText("search.name"))}}).blur();h.submit(function(j){var i=b("#macro-browser-dialog .dialog-panel-body #category-all .macro-list-item:visible");if(b.trim(c.val())!=""&&i.length==1){i.click()}return AJS.stopEvent(j)});x.page[0].header.append(h);x.page[0].ontabchange=function(i,j){if(i!=x.getPanel(0,0)){if(!c.hasClass("blank-search")){c.val("").blur()}f("")}};x.gotoPanel(0,0);x.ready=true;q.hasInit=true;var k=(new Date()).getTime()-s.getTime();AJS.log("loading macro browser took "+k+"ms");return true},loadModel:function(c){if(!c){AJS.log("AJS.MacroBrowser.loadModel - no macro data, aborting");return}AJS.log("AJS.MacroBrowser.loadModel - starting");var m=AJS.MacroBrowser;m.metadataList=[];m.aliasMap={};for(var e=0,l=c.length;e<l;e++){var k=c[e];if(k.aliases){for(var d=0,f=k.aliases.length;d<f;d++){k.aliases[d]=k.aliases[d].toLowerCase();m.aliasMap[k.aliases[d]]=k.macroName.toLowerCase()}}if(k.title==m.makeDefaultKey(k.pluginKey,k.macroName,"label")){k.title=k.macroName.charAt(0).toUpperCase()+k.macroName.substring(1).replace(/-/g," ")}if(k.description==m.makeDefaultKey(k.pluginKey,k.macroName,"desc")){k.description=""}k.id="macro-"+(k.alternateId||k.macroName);var g=[k.macroName,k.title].concat(k.aliases);k.keywordsNoDesc=g.join(",");var h=(k.description&&k.description.replace(/,/g," "))||"";g.push(h);k.keywords=g.join(",");m.metadataList.push(k)}m.metadataList.sort(function(j,i){return(j.title.toLowerCase()>i.title.toLowerCase()?1:-1)});AJS.log("AJS.MacroBrowser.loadModel - complete, "+m.metadataList.length+" macros loaded")},searchSummaries:function(d,c){c=b.extend({splitRegex:/[\s\-]+/},c);return AJS.filterBySearch(this.metadataList,d,c)}}})(AJS.$);AJS.toInit(function(a){a(window).bind("render-content-loaded",function(d,b){var c=a("#macro-preview-iframe");if(c.contents().find("body")[0]==b){AJS.MacroBrowser.previewOnload(b)}});setTimeout(function(){var b=AJS.MacroBrowser;AJS.$.ajax({type:"GET",dataType:"json",url:AJS.params.contextPath+"/plugins/macrobrowser/browse-macros.action",success:function(c){b.initData=c;b.loadModel(c.macros);if(b.initMacroBrowserAfterRequest){b.initBrowser();b.openMacroBrowser(b.initMacroBrowserAfterRequest)}},error:function(c){AJS.log("Error requesting macro browser metadata:");AJS.log(c);b.initData={}}})},500)});