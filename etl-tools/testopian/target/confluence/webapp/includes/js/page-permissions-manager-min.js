AJS.PagePermissions=AJS.PagePermissions||{};AJS.$.fn.disable=function(a){return this.each(function(){var b=AJS.$(this);var c=b.attr("disabled","disabled").addClass("disabled").attr("id");if(c){AJS.$("label[for="+c+"]",b.parent()).addClass("disabled")}})};AJS.$.fn.enable=function(a){return this.each(function(){var b=AJS.$(this);var c=b.attr("disabled","").removeClass("disabled").attr("id");if(c){AJS.$("label[for="+c+"]",b.parent()).removeClass("disabled")}})};AJS.toInit(function(e){var h="user",t="group";var k=e("#confluence-context-path").attr("content");var o=!!e("#permissions-show-hide-link").length;var a=null;var l=null;var r=null;var n={addNames:function(v,x){var w=this;var u=v.replace(/\s*,\s*/g,",").split(",");var y=e("#waitImage");y.show();var z={name:u,type:x||"",pageId:AJS.params.parentPageId,spaceKey:AJS.params.spaceKeyDecoded};e.getJSON(k+"/pages/getentities.action",z,function(F){y.hide();for(var E=0,A=F.length;E<A;E++){var C=F[E].entity;var B=F[E].report;w.addEntity(F[E]);var D=e.inArray(C.name,u);u.splice(D,1)}l.validator.handleNonExistentEntityNames(u)})},addEntity:function(w){if(!w){return}var v=w.entity;var u=w.report;var y=l.getPermissionType();if(l.validator.isDuplicateEntityForType(v,y)){r.highlightEntityRow(v,y);return}var x={entity:v,view:true,edit:true,report:u};r.addRow(x,y);r.changedByUser();r.highlightEntityRow(v,y);l.nameField.removeFromNameInput(v.name)},makePermissionStrings:function(){var u=r.makePermissionMap(false);return{viewPermissionsUsers:u.user.view.join(","),editPermissionsUsers:u.user.edit.join(","),viewPermissionsGroups:u.group.view.join(","),editPermissionsGroups:u.group.edit.join(",")}},refreshLayout:function(){var z=e("#page-permissions-tables");var y=e("#update-page-restrictions-dialog");var w=y.outerHeight();var u=y.find("h2").outerHeight();var B=y.find(".dialog-button-panel").outerHeight();var x=w-(u+B);var A=e("#page-permissions-editor-form").outerHeight();var v=x-A;e("#update-page-restrictions-dialog .dialog-panel-body").height(x);z.height(v)}};e.extend(AJS.PagePermissions,{addUserPermissions:function(u){n.addNames(u,h)},addGroupPermissions:function(u){n.addNames(u,t)},makePermissionStrings:n.makePermissionStrings});function f(w){r.allowEditing(w.userCanEditRestrictions);r.resetInherited();if(!n.permissionsEdited){r.resetDirect()}if(!w){return}for(var x=0,z=w.permissions.length;x<z;x++){var F=w.permissions[x];var B=F[0].toLowerCase();var u=F[1];var D=F[2];var v=(u==h)?w.users[D]:w.groups[D];var E=F[3];var C=F[4];var y=+E&&E!=AJS.params.pageId;if(n.permissionsEdited&&!y){continue}var A={owningId:E,entity:v.entity,report:v.report};A[B]=true;A.owningTitle=C;A.inherited=y;r.addRow(A,B)}r.saveBackup();r.refresh()}function i(){var B=r.makePermissionMap(true);var v=e("#permissions-view-summary");var z=[].concat(B.group.view).concat(B.user.view);if(z.length){v.find(".summary-content").text(z.join(", "))}AJS.setVisible(v,z.length);var x=e("#permissions-edit-summary");var u=[].concat(B.group.edit).concat(B.user.edit);if(u.length){x.find(".summary-content").text(u.join(", "))}AJS.setVisible(x,u.length);n.permissionsEdited=false;var A=n.makePermissionStrings();for(var w in A){var y=A[w];e("#"+w).val(y);if(n.originalPermissions[w]!=y){n.permissionsEdited=true}}}function q(){l.validator.resetValidationErrors();r.clearHighlight();a.hide();window.scrollTo(n.bookmark.scrollX,n.bookmark.scrollY)}function g(){var v=e(".permissions-update-button").disable();if(o){i();AJS.setVisible("#page-permissions-unsaved-changes-msg",n.permissionsEdited);v.enable();q()}else{var u=n.makePermissionStrings();u.pageId=AJS.params.pageId;e("#waitImage").show();AJS.safe.post(k+"/pages/setpagepermissions.action",u,function(w){e("#waitImage").hide();AJS.setVisible("#content-metadata-page-restrictions",w.hasPermissions);v.enable();q()},"json")}}function d(){q();if(o){r.restoreBackup()}}function p(){a=AJS.ConfluenceDialog({width:865,height:530,id:"update-page-restrictions-dialog",onCancel:d});a.addHeader(AJS.I18n.getText("page.perms.dialog.heading"));a.addPanel("Page Permissions Editor",AJS.renderTemplate("page-permissions-div"));a.addButton(AJS.I18n.getText("update.name"),g,"permissions-update-button");a.addCancel(AJS.I18n.getText("close.name"),d);a.popup.element.find(".dialog-title").append(AJS.template.load("page-restrictions-help-link"));l=AJS.PagePermissions.Controls(n);var u=e("#page-permissions-table").bind("changed",s);r=AJS.PagePermissions.Table(u);n.table=r}function j(u){n.bookmark={scrollX:document.documentElement.scrollLeft,scrollY:document.documentElement.scrollTop};b();l.setVisible(u.userCanEditRestrictions);AJS.setVisible(".permissions-update-button",u.userCanEditRestrictions);a.show();n.refreshLayout()}function c(y,v){var w=(v&&e("#newSpaceKey").val())||AJS.params.spaceKeyDecoded;var u=(v&&e("#parentPageString").val())||"";var x={pageId:AJS.params.pageId,parentPageId:AJS.params.parentPageId,parentPageTitle:u,spaceKey:w};if(AJS.params.newPage){x.draftId=AJS.params.contentId}e("#waitImage").show();e.getJSON(k+"/pages/getpagepermissions.action",x,function(z){e("#waitImage").hide();f(z);y(z)})}function m(u){a||p();c(j,u)}function s(){e(".permissions-update-button").enable();e(".button-panel-cancel-link").text(AJS.I18n.getText("cancel.name"))}function b(){e(".permissions-update-button").disable();e(".button-panel-cancel-link").text(AJS.I18n.getText("close.name"))}e("#content-metadata-page-restrictions, #action-page-permissions-link").click(function(u){m(false);u.preventDefault()});e("#permissions-show-hide-link").click(function(u){m(true);u.preventDefault()});if(o){n.originalPermissions={viewPermissionsUsers:e("#viewPermissionsUsers").val(),editPermissionsUsers:e("#editPermissionsUsers").val(),viewPermissionsGroups:e("#viewPermissionsGroups").val(),editPermissionsGroups:e("#editPermissionsGroups").val()}}});