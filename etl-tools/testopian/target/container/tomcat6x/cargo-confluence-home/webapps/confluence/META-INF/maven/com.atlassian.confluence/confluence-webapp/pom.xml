<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.atlassian.confluence</groupId>
        <artifactId>confluence-project</artifactId>
        <version>3.5</version>
    </parent>

    <artifactId>confluence-webapp</artifactId>
    <packaging>war</packaging>

    <name>Confluence Webapp</name>

    <scm>
        <connection>scm:svn:https://svn.atlassian.com/svn/private/atlassian/confluence/tags/confluence-project-3.5/conf-webapp</connection>
        <developerConnection>scm:svn:https://svn.atlassian.com/svn/private/atlassian/confluence/tags/confluence-project-3.5/conf-webapp</developerConnection>
        <url>https://svn.atlassian.com/svn/private/atlassian/confluence/tags/confluence-project-3.5/conf-webapp</url>
    </scm>

    <dependencies>

        <dependency>
            <groupId>com.atlassian.confluence</groupId>
            <artifactId>confluence</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>com.atlassian.confluence</groupId>
            <artifactId>confluence-compatibility</artifactId>
            <version>${project.version}</version>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>com.atlassian.confluence.cache</groupId>
            <artifactId>confluence-cache-ehcache</artifactId>
            <version>${project.version}</version>
            <scope>runtime</scope>
        </dependency>

        <!-- bundled JDBC drivers -->
        <dependency>
            <groupId>net.sourceforge.jtds</groupId>
            <artifactId>jtds</artifactId>
            <version>1.2.2</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <version>8.4-701.jdbc3</version>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.11</version>
        </dependency>

        <!-- Platform 2.7 requirement -->
        <dependency>
            <groupId>com.sun.xml.bind</groupId>
            <artifactId>jaxb-impl</artifactId>
        </dependency>

        <!-- SAL Api -->
        <dependency>
            <groupId>com.atlassian.sal</groupId>
            <artifactId>sal-api</artifactId>
        </dependency>

        <!-- AppLinks -->
        <dependency>
            <groupId>com.atlassian.applinks</groupId>
            <artifactId>applinks-api</artifactId>
        </dependency>
        <dependency>
            <groupId>com.atlassian.applinks</groupId>
            <artifactId>applinks-spi</artifactId>
        </dependency>
        <dependency>
            <groupId>com.atlassian.applinks</groupId>
            <artifactId>applinks-host</artifactId>
        </dependency>

        <!-- JSON (Required by applinks) -->
        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
        </dependency>
        
        <!-- Remote API Plugin -->
        <dependency>
            <groupId>com.atlassian.confluence.plugins</groupId>
            <artifactId>confluence-rpc-plugin</artifactId>
            <version>${project.version}</version>
            <scope>runtime</scope>
        </dependency>
        
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>servlet-api</artifactId>
        </dependency>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <dependency>
            <groupId>mockobjects</groupId>
            <artifactId>mockobjects-core</artifactId>
        </dependency>
        <dependency>
            <groupId>mockobjects</groupId>
            <artifactId>mockobjects</artifactId>
        </dependency>

        <dependency>
            <groupId>com.atlassian.confluence</groupId>
            <artifactId>confluence-acceptance-test</artifactId>
            <version>${project.version}</version>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.testng</groupId>
                    <artifactId>testng</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <!-- test dependencies required by Jetty test harness -->
        <dependency>
            <groupId>org.mortbay.jetty</groupId>
            <artifactId>jetty</artifactId>
            <version>6.1.5</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.mortbay.jetty</groupId>
            <artifactId>jetty-management</artifactId>
            <version>6.1.5</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>jsp-api</artifactId>
            <version>2.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>tomcat</groupId>
            <artifactId>jasper-runtime</artifactId>
            <version>5.0.28</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>commons-el</groupId>
            <artifactId>commons-el</artifactId>
            <version>1.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>rhino</groupId>
            <artifactId>js</artifactId>
            <version>1.7R2</version>
            <scope>test</scope>
        </dependency>
        
        <!-- script macro dependencies -->
        <!-- deprecated since 3.0, used by plugins -->
        <dependency>
            <groupId>bsf</groupId>
            <artifactId>bsf</artifactId>
            <version>2.3.0</version>
            <scope>runtime</scope>
        </dependency>
        <!-- deprecated since 3.0, used by plugins -->
        <dependency>
            <groupId>jython</groupId>
            <artifactId>jython</artifactId>
            <version>2.1-forked</version>
            <scope>runtime</scope>
        </dependency>
    </dependencies>

    <build>
        <finalName>confluence</finalName>
        <resources>
            <resource>
                <directory>src/main/resources</directory>
                <excludes>
                    <exclude>confluence-init.properties</exclude>
                </excludes>
            </resource>
        </resources>
        <plugins>
            <!--<plugin>
                <groupId>com.atlassian.maven.plugins</groupId>
                <artifactId>modz-detector-maven-plugin</artifactId>
                <version>0.8</version>
                <executions>
                    <execution>
                        <phase>prepare-package</phase>
                        <goals>
                            <goal>generate-registry</goal>
                        </goals>
                        <configuration>
                            <classpath>
                                <directory>${project.build.directory}/${project.build.finalName}/WEB-INF/classes
                                </directory>
                                <includes>**/*</includes>
                                <excludes>confluence-init.properties,hash-registry.properties</excludes>
                            </classpath>
                            <filesystem>
                                <directory>${project.build.directory}/${project.build.finalName}</directory>
                                <excludes>WEB-INF/classes/**/*</excludes>
                            </filesystem>
                        </configuration>
                    </execution>
                </executions>
            </plugin>-->


            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-antrun-plugin</artifactId>
                <executions>
                    <execution>
                        <phase>generate-resources</phase>
                        <goals>
                            <goal>run</goal>
                        </goals>
                        <configuration>
                            <target>
                                <copy todir="src/main/resources/com/atlassian/confluence/setup" flatten="true" overwrite="true">
                                    <fileset dir="../confluence-bundled-plugins-library/target">
                                        <include name="*.zip" />
                                    </fileset>
                                </copy>
                            </target>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>xml-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <id>web.resin3.xml</id>
                        <configuration>
                            <transformationSets>
                                <transformationSet>
                                    <dir>src/main/webapp/WEB-INF/</dir>
                                    <includes>
                                        <include>web.xml</include>
                                    </includes>
                                    <stylesheet>src/main/xml/resin3patch.xslt</stylesheet>
                                    <outputDir>${project.build.directory}/${project.build.finalName}/WEB-INF</outputDir>
                                    <fileMappers>
                                        <fileMapper implementation="org.codehaus.plexus.components.io.filemappers.MergeFileMapper">
                                            <targetName>web.resin3.xml</targetName>
                                        </fileMapper>
                                    </fileMappers>
                                </transformationSet>
                            </transformationSets>
                        </configuration>
                        <goals>
                            <goal>transform</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>web.servlet2-4.xml</id>
                        <configuration>
                            <transformationSets>
                                <transformationSet>
                                    <dir>src/main/webapp/WEB-INF/</dir>
                                    <includes>
                                        <include>web.xml</include>
                                    </includes>
                                    <stylesheet>src/main/xml/servlet2-4patch.xslt</stylesheet>
                                    <outputDir>${project.build.directory}/${project.build.finalName}/WEB-INF</outputDir>
                                    <fileMappers>
                                        <fileMapper implementation="org.codehaus.plexus.components.io.filemappers.MergeFileMapper">
                                            <targetName>web.servlet2-4.xml</targetName>
                                        </fileMapper>
                                    </fileMappers>
                                </transformationSet>
                            </transformationSets>
                        </configuration>
                        <goals>
                            <goal>transform</goal>
                        </goals>
                    </execution>
                </executions>
                <dependencies>
                    <dependency>
                        <groupId>net.sf.saxon</groupId>
                        <artifactId>saxon</artifactId>
                        <version>8.7</version>
                    </dependency>
                </dependencies>
            </plugin>
            <plugin>
                <groupId>net.alchim31.maven</groupId>
                <artifactId>yuicompressor-maven-plugin</artifactId>
                <version>1.1</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>compress</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <!-- Everything on one line -->
                    <linebreakpos>-1</linebreakpos>
                    <!-- Turning off JSlint warnings -->
                    <jswarn>false</jswarn>
                    <excludes>
                        <!--skip calendar library as it breaks the yui compressor-->
                        <exclude>**/js/calendar/**</exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>

    <profiles>
        <!-- WARNING: This profile must be first otherwise the tests get screwed up -->
        <profile>
            <!-- This profile declaration deactivates the run-acceptance-test profile when the tests are skipped. -->
            <id>do-not-run-any-tests</id>
            <activation>
                <property>
                    <name>maven.test.skip</name>
                </property>
            </activation>
        </profile>
        <profile>
            <!-- This profile exists to deactivate the run-acceptance-test profile when the extended-acceptance-test
                 profile is enabled (see confluence-test-runner/pom.xml).-->
            <id>extended-acceptance-test</id>
        </profile>
        <profile>
            <!-- Note that this will run unless some other profile disables it.  If you need this profile and another
                 one, you'll have to enable this profile explicitly. -->
            <id>run-acceptance-test</id>
            <activation>
                <activeByDefault>true</activeByDefault>
            </activation>
            <build>
                <plugins>
                    <plugin>
                        <artifactId>maven-clean-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>clean_confluence_home</id>
                                <phase>pre-integration-test</phase>
                                <goals>
                                    <goal>clean</goal>
                                </goals>
                                <configuration>
                                    <excludeDefaultDirectories>true</excludeDefaultDirectories>
                                    <filesets>
                                        <fileset>
                                            <directory>${project.build.directory}/confluence-home</directory>
                                            <includes>
                                                <include>**/*</include>
                                            </includes>
                                        </fileset>
                                    </filesets>
                                    <skip>${keep.confluence.home}</skip>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin>
                        <artifactId>maven-dependency-plugin</artifactId>
                        <executions>
                            <execution>
                                <!--
                        Use the dependency plugin to extract the Confluence acceptance tests into the test output directory
                        -->
                                <id>unpack-confluence-tests</id>
                                <phase>pre-integration-test</phase>
                                <goals>
                                    <goal>unpack-dependencies</goal>
                                </goals>
                                <configuration>
                                    <excludeTransitive>true</excludeTransitive>
                                    <includeArtifactIds>confluence-acceptance-test</includeArtifactIds>
                                    <outputDirectory>${project.build.directory}/it-classes</outputDirectory>
                                </configuration>
                            </execution>
                            <execution>
                                <!--
                                Use the dependency plugin to copy the Confluence dynamic plugins to be installed during testing.
                                -->
                                <id>copy-dynamic-plugins</id>
                                <phase>pre-integration-test</phase>
                                <goals>
                                    <goal>copy-dependencies</goal>
                                </goals>
                                <configuration>
                                    <includeArtifactIds>confluence-functestrpc-plugin,confluence-functestxss-plugin,sal-ctk-plugin,functest-plugin,platform-ctk-plugin,confluence-pseudo-loc</includeArtifactIds>
                                    <stripVersion>true</stripVersion>
                                </configuration>
                            </execution>

                        </executions>
                    </plugin>
                    <plugin>
                        <groupId>org.codehaus.cargo</groupId>
                        <artifactId>cargo-maven2-plugin</artifactId>
                        <configuration>
                            <wait>${cargo.wait}</wait>
                            <container>
                                <containerId>tomcat5x</containerId>
                                <zipUrlInstaller>
                                    <url>${tomcat5.url}</url>
                                    <installDir>${project.build.directory}/installs</installDir>
                                </zipUrlInstaller>
                                <output>${project.build.directory}/output.log</output>
                                <log>${project.build.directory}/cargo-log.log</log>
                                <systemProperties>
                                    <confluence.home>${project.build.directory}/confluence-home</confluence.home>
                                    <clover.distributed.coverage>${clover.distributed.coverage}</clover.distributed.coverage>
                                    <http.port>${http.port}</http.port>
                                </systemProperties>
                            </container>
                            <configuration>
                                <home>${project.build.directory}/tomcat5x/container</home>
                                <properties>
                                    <cargo.servlet.port>${http.port}</cargo.servlet.port>
                                    <cargo.rmi.port>${controller.port}</cargo.rmi.port>
                                    <cargo.jvmargs>${jvm.args}</cargo.jvmargs>
                                </properties>
                                <deployables>
                                    <deployable>
                                        <groupId>com.atlassian.confluence</groupId>
                                        <artifactId>confluence-webapp</artifactId>
                                        <type>war</type>
                                        <properties>
                                            <context>${webappContext}</context>
                                        </properties>
                                        <pingURL>http://localhost:${http.port}/${webappContext}</pingURL>
                                        <pingTimeout>60000</pingTimeout>
                                    </deployable>
                                </deployables>
                            </configuration>
                        </configuration>
                        <executions>
                            <execution>
                                <id>start-container</id>
                                <phase>pre-integration-test</phase>
                                <goals>
                                    <goal>start</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin><!-- This must be run before clover2:optimize. -->
                        <artifactId>maven-surefire-plugin</artifactId>
                        <configuration>
                            <skip>${maven.test.acceptance.skip}</skip>
                            <systemPropertyVariables>
                                <java.io.tmpdir>${java.io.tmpdir}</java.io.tmpdir>
                                <http.port>${http.port}</http.port>
                                <webappContext>${webappContext}</webappContext>
                                <confluence.version>${project.version}</confluence.version>
                                <baseurl>http://localhost:${http.port}/${webappContext}</baseurl>
                                <confluence.log.file.handlers>${confluence.log.file.handlers}</confluence.log.file.handlers>
                                <dynamicPluginDirectory>${project.build.directory}/dependency</dynamicPluginDirectory>
                                <!-- This used to say that these can't be defined only in the 50_acceptance_test execution since config doesn't get merged. This is a lie -->
                                <!-- TODO move to the relevant execution(s), and add combine.children="append" to it to make them merge -->
                                <clover.distributed.coverage>${clover.distributed.coverage}</clover.distributed.coverage>
                                <clover.server>${clover.server}</clover.server>
                                <httpRequestTimeout>${httpRequestTimeout}</httpRequestTimeout>
                                <pause.time.millis>${pause.time.millis}</pause.time.millis>
                            </systemPropertyVariables>
                        </configuration>
                        <executions>
                            <execution>
                                <id>00_setup</id>
                                <phase>pre-integration-test</phase> <!-- Needed so that clover can optimize acceptance tests.-->
                                <goals>
                                    <goal>test</goal>
                                </goals>
                                <configuration>
                                    <skip>${maven.test.acceptance.skip}</skip>
                                    <testClassesDirectory>${project.build.directory}/it-classes</testClassesDirectory>
                                    <includes>
                                        <include>com/atlassian/confluence/setup/SetupAcceptanceTest.java</include>
                                    </includes>
                                </configuration>
                            </execution>
                            <execution>
                                <id>50_acceptance_tests</id>
                                <phase>integration-test</phase>
                                <goals>
                                    <goal>test</goal>
                                </goals>
                                <configuration>
                                    <skip>${maven.test.acceptance.skip}</skip>
                                    <testClassesDirectory>${project.build.directory}/it-classes</testClassesDirectory>
                                    <includes>
                                        <include>com/atlassian/confluence/*AcceptanceTest.java</include>
                                        <include>com/atlassian/confluence/rest/*AcceptanceTest.java</include>
                                        <include>com/atlassian/confluence/dashboard/**/*.java</include>
                                        <include>com/atlassian/confluence/multimedia/**/*.java</include>
                                    </includes>
                                    <excludes>
                                        <exclude>**/Abstract*.java</exclude>
                                        <exclude>com/atlassian/confluence/KnownBugsAcceptanceTest.java</exclude>
                                    </excludes>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>setup</id>
            <build>
                <plugins>
                    <plugin>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>00_setup</id>
                                <goals>
                                    <goal>test</goal>
                                </goals>
                                <configuration>
                                    <skip>false</skip>
                                </configuration>
                            </execution>
                            <execution>
                                <id>50_acceptance_tests</id>
                                <goals>
                                    <goal>test</goal>
                                </goals>
                                <configuration>
                                    <skip>true</skip>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>clover-optimize</id>
            <dependencies>
                <dependency>
                    <groupId>com.cenqua.clover</groupId>
                    <artifactId>clover</artifactId>
                    <version>${clover.version}</version>
                </dependency>
            </dependencies>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.codehaus.mojo</groupId>
                        <artifactId>build-helper-maven-plugin</artifactId>
                        <version>1.2</version>
                        <executions>
                            <execution>
                                <id>add-test-source</id>
                                <phase>process-test-classes</phase>
                                <goals>
                                    <goal>add-test-source</goal>
                                </goals>
                                <configuration>
                                    <sources>
                                        <source>../conf-acceptance-test/src/main/java/</source>
                                    </sources>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin>
                        <groupId>com.atlassian.maven.plugins</groupId>
                        <artifactId>maven-up-and-down-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>download-clover-snapshot</id>
                                <phase>generate-test-resources</phase>
                                <goals>
                                    <goal>download</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                    <plugin>
                        <groupId>com.atlassian.maven.plugins</groupId>
                        <artifactId>maven-clover2-plugin</artifactId>
                        <configuration>
                            <singleCloverDatabase>true</singleCloverDatabase>
                            <flushPolicy>directed</flushPolicy>
                            <instrumentation>method</instrumentation>
                            <snapshot>${project.build.directory}/clover.snapshot</snapshot>
                            <!-- never do a full build -->
                            <fullRunEvery>100000</fullRunEvery>
                            <forceSnapshot>true</forceSnapshot>
                            <optimizeIncludes>
                                <optimizeInclude>com/atlassian/confluence/*AcceptanceTest.java</optimizeInclude>
                                <optimizeInclude>com/atlassian/confluence/rest/*AcceptanceTest.java</optimizeInclude>
                            </optimizeIncludes>
                            <optimizeExcludes>
                                <optimizeExclude>com/atlassian/confluence/Abstract*.java</optimizeExclude>
                                <optimizeExclude>com/atlassian/confluence/KnownBugsAcceptanceTest.java</optimizeExclude>
                                <!-- TODO: Clover causes this test to FAIL due to duplicates on the classpath. -->
                                <optimizeExclude>com/atlassian/confluence/ClasspathAcceptanceTest.java</optimizeExclude>
                            </optimizeExcludes>
                        </configuration>
                        <executions>
                            <execution>
                                <id>10_setup</id>
                                <phase>pre-integration-test</phase>
                                <goals>
                                    <goal>optimize</goal>
                                </goals>
                            </execution>
                            <execution>
                                <id>update-clover-snapshot</id>
                                <phase>post-integration-test</phase>
                                <goals>
                                    <goal>snapshot</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
            <properties>
                <clover.distributed.coverage>port=${clover.port};numClients=1;timeout=${clover.timeout}</clover.distributed.coverage>
                <clover.server>true</clover.server>
                <http.port>47372</http.port>
                <cargo.rmi.port>47373</cargo.rmi.port>
                <jvm.args>-XX:MaxPermSize=256M  -Djava.awt.headless=true -Xmx512m</jvm.args>
                <clover.port>8888</clover.port>
                <clover.timeout>5000</clover.timeout>
                <clover.distributed.coverage>OFF</clover.distributed.coverage> <!-- Specified to all -->
                <failIfNoTests>false</failIfNoTests>
            </properties>
        </profile>
        <profile>
            <id>clover-optimize-bamboo</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>com.atlassian.maven.plugins</groupId>
                        <artifactId>maven-up-and-down-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>deploy-clover-snapshot</id>
                                <phase>verify</phase>
                                <goals>
                                    <goal>deploy</goal>
                                </goals>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>

        <profile>
            <id>netstat</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.codehaus.mojo</groupId>
                        <artifactId>exec-maven-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>00_exec_netstat_pre</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>exec</goal>
                                </goals>
                                <configuration>
                                    <executable>/bin/netstat</executable>
                                    <arguments>
                                        <argument>-nap</argument>
                                    </arguments>
                                </configuration>
                            </execution>
                            <execution>
                                <id>01_exec_ps_pre</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>exec</goal>
                                </goals>
                                <configuration>
                                    <executable>/bin/ps</executable>
                                    <arguments>
                                        <argument>auxwww</argument>
                                    </arguments>
                                </configuration>
                            </execution>
                            <execution>
                                <id>00_exec_netstat_post</id>
                                <phase>post-integration-test</phase>
                                <goals>
                                    <goal>exec</goal>
                                </goals>
                                <configuration>
                                    <executable>/bin/netstat</executable>
                                    <arguments>
                                        <argument>-nap</argument>
                                    </arguments>
                                </configuration>
                            </execution>
                            <execution>
                                <id>01_exec_ps_post</id>
                                <phase>post-integration-test</phase>
                                <goals>
                                    <goal>exec</goal>
                                </goals>
                                <configuration>
                                    <executable>/bin/ps</executable>
                                    <arguments>
                                        <argument>auxwww</argument>
                                    </arguments>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>full</id>
            <build>
                <plugins>
                    <plugin>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>50_acceptance_tests</id>
                                <phase>integration-test</phase>
                                <goals>
                                    <goal>test</goal>
                                </goals>
                                <configuration>
                                    <skip>${maven.test.acceptance.skip}</skip>
                                    <testClassesDirectory>${project.build.directory}/it-classes</testClassesDirectory>
                                    <includes>
                                        <include>com/atlassian/confluence/*AcceptanceTest.java</include>
                                        <include>com/atlassian/confluence/rest/*AcceptanceTest.java</include>
                                    </includes>
                                    <excludes>
                                        <exclude>com/atlassian/confluence/Abstract*.java</exclude>
                                        <exclude>com/atlassian/confluence/KnownBugsAcceptanceTest.java</exclude>
                                    </excludes>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>tomcat6</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.codehaus.cargo</groupId>
                        <artifactId>cargo-maven2-plugin</artifactId>
                        <configuration>
                            <wait>${cargo.wait}</wait>
                            <container>
                                <containerId>tomcat6x</containerId>
                                <zipUrlInstaller>
                                    <url>${tomcat6.url}</url>
                                    <installDir>target/installs</installDir>
                                </zipUrlInstaller>
                            </container>
                        </configuration>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <id>speed</id>
            <build>
                <plugins>
                    <plugin>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <executions>
                            <execution>
                                <id>50_acceptance_tests</id>
                                <phase>integration-test</phase>
                                <goals>
                                    <goal>test</goal>
                                </goals>
                                <configuration>
                                    <skip>${maven.test.acceptance.skip}</skip>
                                    <testClassesDirectory>${project.build.directory}/it-classes</testClassesDirectory>
                                    <includes>
                                        <include>com/atlassian/confluence/*AcceptanceTest.java</include>
                                        <include>com/atlassian/confluence/rest/*AcceptanceTest.java</include>
                                    </includes>
                                    <excludes>
                                        <exclude>com/atlassian/confluence/Abstract*.java</exclude>
                                        <exclude>com/atlassian/confluence/KnownBugsAcceptanceTest.java</exclude>
                                        <exclude>**/*JavaScript*.java</exclude>
                                        <exclude>**/*DashboardAcceptanceTest*.java</exclude>
                                        <exclude>**/*PeopleDirectoryAcceptanceTest*.java</exclude>
                                        <exclude>**/*Javascript*.java</exclude>
                                        <exclude>**/*PopupWindows*.java</exclude>
                                        <exclude>**/*ContentPermissionImportAcceptanceTest.java</exclude>
                                        <exclude>**/*HtmlExportAcceptanceTest.java</exclude>
                                        <exclude>**/*SiteImportAcceptanceTest*.java</exclude>
                                        <exclude>**/*InsertImage*Test.java</exclude>
                                        <exclude>**/*BrokenSpacePermissionsImportAcceptanceTest.java</exclude>
                                        <exclude>**/*BrokenSpacePermissionsImportAcceptanceTest.java</exclude>
                                        <exclude>**/*BlogSlowAcceptanceTest.java</exclude>
                                        <exclude>**/*ThumbnailAcceptanceTest.java</exclude>
                                        <!-- Possible candidates for removal -->
                                        <!--exclude>**/*AttachmentAcceptanceTest.java</exclude-->
                                    </excludes>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
        </profile>
        <profile>
            <!-- See https://bamboo.extranet.atlassian.com/browse/RELENG-CONFSUCCESS.  This
                should be replaced with properties passed in from the build. -->
            <id>devspeed-build</id>
            <properties>
                <http.port>47382</http.port>
                <cargo.rmi.port>47383</cargo.rmi.port>
            </properties>
        </profile>
        <profile>
            <id>debug</id>
            <properties>
                <jvm.args>${jvm.args.debug}</jvm.args>
            </properties>
        </profile>
        <profile>
            <id>jetty-exploded-war</id>
            <build>
                <defaultGoal>org.mortbay.jetty:maven-jetty-plugin:6.1.12.rc5:run-exploded</defaultGoal>
                <plugins>
                    <plugin>
                        <groupId>org.mortbay.jetty</groupId>
                        <artifactId>maven-jetty-plugin</artifactId>
                        <version>6.1.12.rc5</version>
                        <configuration>
                            <contextPath>${webappContext}</contextPath>
                            <scanIntervalSeconds>10</scanIntervalSeconds>
                            <systemProperties>
                                <systemProperty>
                                    <name>confluence.home</name>
                                    <value>${project.build.directory}/confluence-home</value>
                                </systemProperty>
                                <systemProperty>
                                    <name>XX:MaxPermSize</name>
                                    <value>256M</value>
                                </systemProperty>
                                <systemProperty>
                                    <name>Xmx</name>
                                    <value>256M</value>
                                </systemProperty>
                            </systemProperties>
                        </configuration>
                    </plugin>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <configuration>
                            <skipTests>true</skipTests>
                        </configuration>
                    </plugin>
                </plugins>
            </build>
            <properties>
                <http.port>8080</http.port>
                <jetty.port>${http.port}</jetty.port>
            </properties>
        </profile>
        <profile>
            <id>smart-sprites</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.codehaus.mojo</groupId>
                        <artifactId>exec-maven-plugin</artifactId>
                        <dependencies>
                            <dependency>
                                <groupId>org.carrot2.labs</groupId>
                                <artifactId>smart-sprites</artifactId>
                                <version>0.2.6</version>
                            </dependency>
                        </dependencies>
                        <executions>
                            <execution>
                                <phase>process-resources</phase>
                                <goals>
                                    <goal>java</goal>
                                </goals>
                                <configuration>
                                    <mainClass>org.carrot2.labs.smartsprites.SmartSprites</mainClass>
                                    <executableDependency>
                                        <groupId>org.carrot2.labs</groupId>
                                        <artifactId>smart-sprites</artifactId>
                                    </executableDependency>
                                    <includePluginDependencies>true</includePluginDependencies>
                                    <!-- We don't need any project dependencies-->
                                    <includeProjectDependencies>false</includeProjectDependencies>
                                    <arguments>
                                        <!-- The values have to be entered as two separate arguments -->
                                        <argument>--root-dir-path</argument>
                                        <argument>src/main/webapp</argument>
                                    </arguments>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>
                </plugins>
            </build>
            <properties>
                <maven.yuicompressor.skip>true</maven.yuicompressor.skip>
            </properties>
        </profile>
    </profiles>

    <properties>
        <!-- This should use ${project.build.directory} instead of target, but Maven < 2.0.9 fails to interpolate. -->
        <pluginBundleDirectory>target/bundled-plugins</pluginBundleDirectory>
        <cargo.wait>false</cargo.wait>
        <http.port>47362</http.port>
        <controller.port>47363</controller.port>
        <jvm.args.extra>-Xms512m -Dcom.atlassian.logout.invalidatesession=true -Dconfluence.invalidate.rpc.sessions=true</jvm.args.extra>
        <jvm.args.xmx>512m</jvm.args.xmx>
        <!-- MaxPermSize has been 128M for a long time.  Increased, possibly temporarily, to 192M for CONF-18277 -->
        <jvm.args.maxpermsize>192m</jvm.args.maxpermsize>
        <jvm.args>-XX:MaxPermSize=${jvm.args.maxpermsize} -Xmx${jvm.args.xmx} -Djava.awt.headless=true ${jvm.args.extra} -XX:+HeapDumpOnOutOfMemoryError</jvm.args>
        <jvm.args.devmode>-Dconfluence.devmode=true -Datlassian.dev.mode=true</jvm.args.devmode>
        <jvm.args.debug>-XX:MaxPermSize=${jvm.args.maxpermsize} -Xmx${jvm.args.xmx} -Djava.awt.headless=true ${jvm.args.extra} -XX:+HeapDumpOnOutOfMemoryError -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005 ${jvm.args.devmode}</jvm.args.debug>

        <webappContext>confluence</webappContext>
        <baseurl>http://localhost:${http.port}/${webappContext}</baseurl>
        <confluence.log.file.handlers>false</confluence.log.file.handlers>
        <clover.distributed.coverage>OFF</clover.distributed.coverage>
        <clover.server>false</clover.server>
    </properties>
</project>
